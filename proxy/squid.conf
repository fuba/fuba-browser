# Squid configuration for fuba-proxy
# Listens only on localhost; external access via stunnel (mTLS)

http_port 127.0.0.1:3128

# --- Memory and cache tuning (target: 1GB total) ---
cache_mem 256 MB
maximum_object_size_in_memory 4 MB
maximum_object_size 64 MB
cache_dir ufs /var/spool/fuba-proxy 512 16 256
cache_swap_low 90
cache_swap_high 95

# --- Logging ---
access_log daemon:/var/log/fuba-proxy/access.log squid
cache_log /var/log/fuba-proxy/cache.log
cache_store_log none

# --- PID file ---
pid_filename /run/fuba-proxy/squid.pid

# --- Worker configuration ---
workers 1

# --- DNS ---
dns_nameservers 8.8.8.8 8.8.4.4
positive_dns_ttl 5 minutes
negative_dns_ttl 30 seconds

# --- Private network blocking (always active) ---
# Block access to private/reserved IP ranges after DNS resolution
acl private_networks dst 10.0.0.0/8
acl private_networks dst 172.16.0.0/12
acl private_networks dst 192.168.0.0/16
acl private_networks dst 127.0.0.0/8
acl private_networks dst 169.254.0.0/16
acl private_networks dst 0.0.0.0/8
acl private_networks dst 100.64.0.0/10
acl private_networks dst fc00::/7
acl private_networks dst fe80::/10
acl private_networks dst ::1/128
http_access deny private_networks

# --- Allowlist mode (toggled by install.sh) ---
# When enabled, only domains in allowlist.txt are permitted
# include /etc/fuba-proxy/allowlist-acl.conf

# --- Port restrictions ---
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# --- Source restriction ---
# Only allow connections from localhost (stunnel terminates TLS here)
acl localhost_src src 127.0.0.1/32
acl localhost_src src ::1/128
http_access allow localhost_src
http_access deny all

# --- Miscellaneous ---
forwarded_for off
via off
httpd_suppress_version_string on
visible_hostname fuba-proxy

# --- Timeout settings ---
connect_timeout 30 seconds
read_timeout 5 minutes
request_timeout 5 minutes
client_lifetime 1 hour

# --- Connection limits ---
max_filedescriptors 4096
